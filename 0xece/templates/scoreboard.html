{% extends "base.html" %}

{% block title %}Scoreboard - {{ ctf_name }}{% endblock %}

{% block content %}
<div class="container">
    <header class="text-center mb-4">
        <h1 class="animate-slide-up">Scoreboard</h1>
        <p class="mt-2" style="color: var(--text-gray);">Classement des meilleurs hackers</p>
    </header>

    <!-- Score Graph -->
    <div class="card mb-4 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="card-body">
            <canvas id="score-graph" height="300"></canvas>
        </div>
    </div>

    <!-- Scoreboard Table -->
    <div class="animate-slide-up" style="animation-delay: 0.2s;">
        <table class="scoreboard-table" id="scoreboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>{% if get_config('user_mode') == 'teams' %}Team{% else %}User{% endif %}</th>
                    <th class="text-right">Score</th>
                </tr>
            </thead>
            <tbody id="scoreboard-body">
                <!-- Will be populated by JS -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let scoreChart = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadScoreboard();
    });

    async function loadScoreboard() {
        try {
            // Get standings
            const standingsResponse = await CTFd.fetch('/api/v1/scoreboard', {
                method: 'GET',
                credentials: 'same-origin'
            });
            const standingsData = await standingsResponse.json();

            if (standingsData.success) {
                renderScoreboard(standingsData.data);
            }

            // Get top 10 for graph
            const topResponse = await CTFd.fetch('/api/v1/scoreboard/top/10', {
                method: 'GET',
                credentials: 'same-origin'
            });
            const topData = await topResponse.json();

            if (topData.success) {
                renderGraph(topData.data);
            }
        } catch (error) {
            console.error('Error loading scoreboard:', error);
        }
    }

    function renderScoreboard(standings) {
        const tbody = document.getElementById('scoreboard-body');
        tbody.innerHTML = '';

        standings.forEach((entry, index) => {
            const rank = index + 1;
            const tr = document.createElement('tr');
            tr.className = 'animate-slide-up';
            tr.style.animationDelay = `${0.3 + index * 0.03}s`;

            let rankClass = '';
            let rankEmoji = '';
            if (rank === 1) { rankClass = 'rank-1'; rankEmoji = 'ðŸ¥‡'; }
            else if (rank === 2) { rankClass = 'rank-2'; rankEmoji = 'ðŸ¥ˆ'; }
            else if (rank === 3) { rankClass = 'rank-3'; rankEmoji = 'ðŸ¥‰'; }

            const profileUrl = entry.account_type === 'team'
                ? `/teams/${entry.account_id}`
                : `/users/${entry.account_id}`;

            tr.innerHTML = `
            <td class="rank ${rankClass}">${rankEmoji || rank}</td>
            <td class="team-name"><a href="${profileUrl}">${entry.name}</a></td>
            <td class="team-score">${entry.score}</td>
        `;

            tbody.appendChild(tr);
        });
    }

    function renderGraph(topData) {
        const ctx = document.getElementById('score-graph').getContext('2d');

        // Define vibrant colors for top 10
        const colors = [
            '#1bcab7', // teal (accent)
            '#ef4444', // red
            '#8b5cf6', // purple
            '#f59e0b', // amber
            '#ec4899', // pink
            '#3b82f6', // blue
            '#22c55e', // green
            '#f97316', // orange
            '#06b6d4', // cyan
            '#a855f7', // violet
        ];

        // Process data for Chart.js
        const datasets = [];

        Object.keys(topData).forEach((teamId, index) => {
            const team = topData[teamId];
            const data = team.solves.map(solve => ({
                x: new Date(solve.date),
                y: solve.value
            }));

            // Calculate cumulative scores
            let cumulative = 0;
            const cumulativeData = data.map(point => {
                cumulative += point.y;
                return { x: point.x, y: cumulative };
            });

            datasets.push({
                label: team.name,
                data: cumulativeData,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                fill: false,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 3
            });
        });

        if (scoreChart) {
            scoreChart.destroy();
        }

        scoreChart = new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: '#000',
                        titleFont: {
                            family: "'Inter', sans-serif",
                            weight: '700'
                        },
                        bodyFont: {
                            family: "'Inter', sans-serif"
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'DD/MM HH:mm',
                            displayFormats: {
                                hour: 'DD/MM HH:mm'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            font: {
                                family: "'Inter', sans-serif"
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            font: {
                                family: "'Inter', sans-serif",
                                weight: '600'
                            }
                        }
                    }
                }
            }
        });
    }
</script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}