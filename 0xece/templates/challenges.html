{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold" style="color: #000;">Challenges</h1>
        <p style="color: #4a4a4a;">Teste tes comp√©tences en cybers√©curit√©</p>
    </div>

    {% include "components/errors.html" %}

    <div x-data="ChallengeBoard" @load-challenges.window="loadChallenges()"
        @load-challenge.window="loadChallenge($event.detail)">
        <!-- Challenge Modal -->
        <div x-ref="challengeWindow" id="challenge-window" class="modal fade" tabindex="-1" role="dialog" x-data=""
            x-html="$store.challenge.data.view"></div>

        <!-- Loading State -->
        <div x-show="!loaded">
            <div class="min-vh-50 d-flex align-items-center">
                <div class="text-center w-100">
                    <i class="fas fa-circle-notch fa-spin fa-3x fa-fw spinner"></i>
                    <p class="mt-3" style="color: #4a4a4a;">Chargement des challenges...</p>
                </div>
            </div>
        </div>

        <!-- Challenges Loaded -->
        <div x-show="loaded">

            <!-- Section: Entra√Ænement -->
            <template x-if="getChallengesByTag('Entrainement').length > 0">
                <div class="mb-5">
                    <div class="d-flex align-items-center mb-4">
                        <div class="section-icon me-3"
                            style="width: 50px; height: 50px; background: #1bcab7; border: 3px solid #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            üí™</div>
                        <div>
                            <h2 class="mb-0" style="color: #000;">Entra√Ænement</h2>
                            <p class="mb-0" style="color: #6b7280;">Challenges pour progresser √† ton rythme</p>
                        </div>
                    </div>
                    <div class="row g-4">
                        <template x-for="c in getChallengesByTag('Entrainement')" :key="c.id">
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button class="card challenge-card w-100 h-100 text-start border-0"
                                    :class="[c.solved_by_me ? 'challenge-solved' : '']" @click="loadChallenge(c.id)"
                                    style="cursor: pointer;">
                                    <div class="card-body">
                                        <span class="badge mb-2" x-text="c.category"
                                            style="background: #6b7280; color: white; border: 2px solid #000;"></span>
                                        <h5 class="card-title fw-bold" x-text="c.name" style="color: #000;"></h5>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <span class="fw-bold" x-text="c.value + ' pts'"
                                                style="color: #1bcab7; font-size: 1.25rem;"></span>
                                            <span style="color: #6b7280; font-size: 0.875rem;"
                                                x-text="c.solves + ' solves'"></span>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Section: Formation -->
            <template x-if="getChallengesByTag('Formation').length > 0">
                <div class="mb-5">
                    <div class="d-flex align-items-center mb-4">
                        <div class="section-icon me-3"
                            style="width: 50px; height: 50px; background: #8b5cf6; border: 3px solid #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            üéì</div>
                        <div>
                            <h2 class="mb-0" style="color: #000;">Formations</h2>
                            <p class="mb-0" style="color: #6b7280;">Challenges des formations 0xECE</p>
                        </div>
                    </div>
                    <div class="row g-4">
                        <template x-for="c in getChallengesByTag('Formation')" :key="c.id">
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button class="card challenge-card w-100 h-100 text-start border-0"
                                    :class="[c.solved_by_me ? 'challenge-solved' : '']" @click="loadChallenge(c.id)"
                                    style="cursor: pointer;">
                                    <div class="card-body">
                                        <span class="badge mb-2" x-text="c.category"
                                            style="background: #8b5cf6; color: white; border: 2px solid #000;"></span>
                                        <h5 class="card-title fw-bold" x-text="c.name" style="color: #000;"></h5>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <span class="fw-bold" x-text="c.value + ' pts'"
                                                style="color: #1bcab7; font-size: 1.25rem;"></span>
                                            <span style="color: #6b7280; font-size: 0.875rem;"
                                                x-text="c.solves + ' solves'"></span>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Section: Anciens CTFs -->
            <template x-if="getChallengesByTag('CTF').length > 0">
                <div class="mb-5">
                    <div class="d-flex align-items-center mb-4">
                        <div class="section-icon me-3"
                            style="width: 50px; height: 50px; background: #ef4444; border: 3px solid #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            üèÜ</div>
                        <div>
                            <h2 class="mb-0" style="color: #000;">Anciens CTFs</h2>
                            <p class="mb-0" style="color: #6b7280;">Challenges des CTFs organis√©s par 0xECE</p>
                        </div>
                    </div>
                    <div class="row g-4">
                        <template x-for="c in getChallengesByTag('CTF')" :key="c.id">
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button class="card challenge-card w-100 h-100 text-start border-0"
                                    :class="[c.solved_by_me ? 'challenge-solved' : '']" @click="loadChallenge(c.id)"
                                    style="cursor: pointer;">
                                    <div class="card-body">
                                        <span class="badge mb-2" x-text="c.category"
                                            style="background: #ef4444; color: white; border: 2px solid #000;"></span>
                                        <h5 class="card-title fw-bold" x-text="c.name" style="color: #000;"></h5>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <span class="fw-bold" x-text="c.value + ' pts'"
                                                style="color: #1bcab7; font-size: 1.25rem;"></span>
                                            <span style="color: #6b7280; font-size: 0.875rem;"
                                                x-text="c.solves + ' solves'"></span>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Section: Autres (sans tag sp√©cifique) -->
            <template x-if="getChallengesWithoutTags().length > 0">
                <div class="mb-5">
                    <div class="d-flex align-items-center mb-4">
                        <div class="section-icon me-3"
                            style="width: 50px; height: 50px; background: #6b7280; border: 3px solid #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            üî•</div>
                        <div>
                            <h2 class="mb-0" style="color: #000;">Autres Challenges</h2>
                            <p class="mb-0" style="color: #6b7280;">Challenges divers</p>
                        </div>
                    </div>
                    <div class="row g-4">
                        <template x-for="c in getChallengesWithoutTags()" :key="c.id">
                            <div class="col-sm-6 col-md-4 col-lg-3">
                                <button class="card challenge-card w-100 h-100 text-start border-0"
                                    :class="[c.solved_by_me ? 'challenge-solved' : '']" @click="loadChallenge(c.id)"
                                    style="cursor: pointer;">
                                    <div class="card-body">
                                        <span class="badge mb-2" x-text="c.category"
                                            style="background: #6b7280; color: white; border: 2px solid #000;"></span>
                                        <h5 class="card-title fw-bold" x-text="c.name" style="color: #000;"></h5>
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <span class="fw-bold" x-text="c.value + ' pts'"
                                                style="color: #1bcab7; font-size: 1.25rem;"></span>
                                            <span style="color: #6b7280; font-size: 0.875rem;"
                                                x-text="c.solves + ' solves'"></span>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

        </div>
    </div>
</div>

<style>
    .challenge-card {
        transition: all 0.2s ease;
    }

    .challenge-card:hover {
        transform: translate(-4px, -4px) !important;
        box-shadow: 8px 8px 0 #000 !important;
    }

    .challenge-solved {
        opacity: 0.7;
        position: relative;
    }

    .challenge-solved::after {
        content: '‚úì';
        position: absolute;
        top: -8px;
        right: -8px;
        width: 28px;
        height: 28px;
        background: #22c55e;
        border: 2px solid #000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block scripts %}
{{ Assets.js("assets/js/challenges.js") }}
<script>
    // Extend the ChallengeBoard to add tag filtering functions
    document.addEventListener('alpine:init', () => {
        const originalChallengeBoard = Alpine.data('ChallengeBoard');

        Alpine.data('ChallengeBoard', function () {
            return {
                ...originalChallengeBoard.call(this),

                getChallengesByTag(tagName) {
                    const challenges = this.$store.challenge.challenges || [];
                    return challenges.filter(c =>
                        c.tags && c.tags.some(t => t.value.toLowerCase() === tagName.toLowerCase())
                    );
                },

                getChallengesWithoutTags() {
                    const challenges = this.$store.challenge.challenges || [];
                    const specialTags = ['entrainement', 'formation', 'ctf'];
                    return challenges.filter(c => {
                        if (!c.tags || c.tags.length === 0) return true;
                        return !c.tags.some(t => specialTags.includes(t.value.toLowerCase()));
                    });
                }
            };
        });
    });
</script>
{% endblock %}